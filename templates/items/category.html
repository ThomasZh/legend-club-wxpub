<!-- blank page @2017/05/23 -->
<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <title>商品列表</title>
    <meta name="description" content="Material Design Mobile Template">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Icons -->
    <link href="{{ static_url('shuttle/css/ionicons.min.css') }}" media="all" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="{{ static_url('weui/css/weui.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('weui/css/jquery-weui.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/animate.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/materialize.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swipebox.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swiper.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/main.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle-master/css/category.css') }}">
    <script src="{{ static_url('shuttle/js/vendor/modernizr-2.7.1.min.js') }}"></script>
    <style media="screen">
      #content ul{display:none;}
      #c-tab li.current{background-color: white;}
      .modal-content {
        height: auto;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content:space-between;
        align-items:center;
      }
      .cart{
        position: fixed;
        bottom: 3rem;
        left: 1.5rem;
      }
      .mark{
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: block;
        border-radius: 50%;
        background-color: #ef4018;
        width: 1.5rem;
        height: 1.5rem;
        line-height: 1.5rem;
        font-size: 1.2rem;
        text-align: center;
        color:white;
        font-weight: 600;
      }

      .prod_img
      {
        border-radius:0;
        margin-top: -5px;
        left: 2px;
        width: 65px;
        height: 65px;
      }

      .spec_item
      {
        border-top:1px solid #e0e0e0;
      }
    </style>
  </head>
  <body>
    <!-- Main Container -->
    <div id="main" class="main">
      <!-- Toolbar -->
      <div id="toolbar" class="primary-color z-depth-1" style="height:48px;transform: translate3d(0, 0, 0);">
        <!-- Tabs -->
        <ul class="tabs">
          {% for category in categorys %}
            {% if category['_id'] == category_id %}
            <li class="tab col s2"><a onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category['_id'] }}'" class="active">{{ category['title'] }}</a></li>
            {% else %}
            <li class="tab col s2"><a onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category['_id'] }}'">{{ category['title'] }}</a></li>
            {% end %}
          {% end %}
        </ul>
      </div>
      <!-- End of Toolbar -->

      <!-- Page Contents -->
      <div class="with-tab animated fadeinup with-filters">
        <!-- 规格条件 -->
        <div class="fixed" style="width:75%">
          <div class="row filters">
            <div class="col s6 center ">
              <a href="#modal2" class="drop-condition ">
                规格<i class="ion-chevron-down"></i>
              </a>
            </div>
            <div class="col s6 center left-border">
              <a href="#modal1" class="drop-condition">
                品牌<i class="ion-chevron-down"></i>
              </a>
            </div>
          </div>
        </div>
        <!-- 商品分类 -->
        <div id="product1" class="row product">
          <div class="col s3 sub-category" style="position: fixed;z-index:99;height:100%;">
            <ul class="collection" id="c-tab">
              {% for second_category in second_categorys %}
                {% if second_category['_id'] == second_category_id %}
                <li class="collection-item current" ><a data_id= "{{ second_category['_id'] }}" class="second-category-btn" onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category_id }}&second_category_id={{ second_category['_id'] }}'">{{ second_category['title'] }}</a></li>
                {% else %}
                <li class="collection-item" ><a data_id= "{{ second_category['_id'] }}" class="second-category-btn" onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category_id }}&second_category_id={{ second_category['_id'] }}'">{{ second_category['title'] }}</a></li>
                {% end %}
              {% end %}
            </ul>
          </div>
          <div class="col s12" style="margin-top: 4.6rem;padding-left:25%;">
            <ul class="collection" style="display:block;" id="content"></ul>
            <div class="weui-loadmore">
              <i class="weui-loading"></i>
              <span class="weui-loadmore__tips">正在加载</span>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Page Contents -->
    </div>
    <!-- End of Main Container -->
    <!-- 购物车图标 -->
    <div class="floating-button animated bouncein delay-3 cart" style="z-index:999;">
      <a id="shop-car" href="/bf/wx/vendors/{{ club_id }}/items/cart" class="btn-floating btn-large waves-effect waves-light btn z-depth-1">
        <span class=""></span><i class="ion-ios-cart"></i>
      </a>
    </div>
    <!-- Modal Structure -->
    <div id="modal1" class="modal bottom-sheet">
      <div class="modal-content">
        <!-- <h4>Modal Header</h4> -->
        {% for second_brand in second_brands %}
          <span class="checkbox brand" data_id="{{ second_brand['_id'] }}" style="curser:pointer;margin-bottom: 1rem;">{{ second_brand['title'] }}</span>
        {% end %}
      </div>
    </div>

    <div id="modal2" class="modal bottom-sheet">
      <div class="modal-content">
        <!-- <h4>Modal Header</h4> -->
        {% for second_spec in second_specs %}
          <span class="checkbox spec" data_id="{{ second_spec['_id'] }}" style="curser:pointer;margin-bottom: 1rem;">{{ second_spec['title'] }}</span>
        {% end %}
      </div>
    </div>

    <!-- Scripts -->
    <script src="{{ static_url('shuttle/js/vendor/jquery-2.1.0.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/helper.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/HeadsUp.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.smoothState.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.mixitup.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.swipebox.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/masonry.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/swiper.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/materialize.js') }}"></script>
    <script src="{{ static_url('weui/js/jquery-weui.min.js') }}"></script>
    <script src="{{ static_url('shuttle-master/js/category.js') }}"></script>
    <script type="text/javascript">
    $(function(){
        // 二级菜单切换
          var $li = $('#c-tab li');
          var $ul = $('#content ul');
        $li.on('click',function(){
            var $this = $(this);
            var $t = $this.index();
            $li.removeClass('current');
            $this.addClass('current');
            $ul.css('display','none');
            $ul.eq($t).css('display','block');
          });
      // 二级菜单内容查询
      var pageNum = 1;
      var limit = 5;

      // 上拉加载更多start
        var loading = false;  //状态标记
        $(document.body).infinite().on("infinite", function() {
          if(loading) return;
          loading = true;
          setTimeout(function() {
            getitems("categories","{{ second_category_id }}");//获取数据函数
            loading = false;
          }, 1000);   //模拟延迟
        });
      // end
        getitems("categories","{{ second_category_id }}");//获取数据函数
        // 查询二级分类下的商品
        function getitems(dom,id){
          $.ajax({
            type: "GET",
            url: "{{ API_DOMAIN }}/api/def/"+dom+"/"+ id +"/items?attach_category=yes&page="+pageNum+"&limit="+limit,
            dataType: "json",
            headers: {"Authorization":"Bearer {{access_token}}"},
            contentType: 'application/json',
            success: function(data, status, xhr) {
              console.log(data);
              var dataObj = data.rs.data;
              var html = '';
              for (var i=0;i<dataObj.length;i++){
                html += '<li class="collection-item avatar">';
                html += '<img src="'+ dataObj[0]['img'] +'!200x200" class="circle prod_img">';
                html += '<span class="title">'+dataObj[0]['title']+'</span>';
                html += '<p>品牌: '+dataObj[0]['brand_title']+'</p>';

                html += '<ul class="spec_list" style="display:block;">';

                var specs = dataObj[i].specs;
                for(var j = 0;j<specs.length;j++){
                  html += '<li class="spec_item" style="display:block;">';
                  html += '<p>规格: '+specs[j]['title']+'</p>';
                  html += '<div class="hilight">';
                  html += '<span>'+specs[j]['amount']/100+'元/'+specs[j]['unit']+'</span>';
                  html += '<div class="hilight-right hidden">'
                  html += '<a href="#!" class="left-side" spec_id = "'+ specs[j]['spec_id'] +'" data_id = "'+dataObj[i]['_id']+'"><i class="ion-minus-circled"></i></a>';
                  html += '<span class="quantity">0</span>';
                  html += '<a href="#!" class="right-side" spec_id = "'+ specs[j]['spec_id'] +'" data_id = "'+dataObj[i]['_id']+'"><i class="ion-plus-circled"></i></a>';
                  html += '</div></div></li>';
                }
                html += '</ul>';
                html += '</li>';
              }
              $("#content").append(html);
              nodata(dataObj);
              $(document).on('click','.right-side',function(event){
                  var num = $(this).prev().text();
                  var begin_num = num;
                      num ++;
                  $(this).prev().text(num);
                  goods_num = goods_num + 1;
                  if(num == 1){
                    $("#shop-car span:first-child").addClass('mark');
                    $("#shop-car span:first-child").text(goods_num);
                  }else{
                    $("#shop-car span:first-child").text(goods_num);
                  }
                  $(this).parent().removeClass('hidden');
                  var item_id = $(this).attr('data_id');
                  var tem_id = $(this).attr('spec_id');
                  var product_num = parseInt($(this).prev().text())-parseInt(begin_num);
                  var data = {"spec_id":tem_id, "quantity":product_num};
                  var json = JSON.stringify(data);
                  console.log(json);
                  $.ajax({
                    type: "POST",
                    url: "{{ API_DOMAIN }}/api/clubs/{{ club_id }}/cart/items/"+ item_id +"/increase",
                    data: json,
                    dataType: "json",
                    headers: {"Authorization":"Bearer {{access_token}}"},
                    contentType: 'application/json',
                    success: function(data, status, xhr) {
                      console.log(data);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("error");
                    }
                  });
              }).on('click','.left-side',function(){
                var num = $(this).next().text();
                var begin_num = num;
                    num -- ;
                    goods_num = goods_num - 1;

                    $("#shop-car span:first-child").text(goods_num);
                if(num == 0){
                  $(this).parent().addClass('hidden');
                  if(goods_num == 0){
                    $("#shop-car span:first-child").removeClass('mark');
                    $("#shop-car span:first-child").html('');
                  }
                }
                  $(this).next().text(num);
                  var tem_id = $(this).attr('spec_id');
                  var item_id = $(this).attr('data_id');
                  var product_num = parseInt(begin_num) - parseInt($(this).next().text());
                  var data = {"spec_id":tem_id,"quantity":product_num};
                  var json = JSON.stringify(data);
                  console.log(json);
                  $.ajax({
                    type: "POST",
                    url: "{{ API_DOMAIN }}/api/clubs/{{ club_id }}/cart/items/"+ item_id +"/decrease",
                    data: json,
                    dataType: "json",
                    headers: {"Authorization":"Bearer {{access_token}}"},
                    contentType: 'application/json',
                    success: function(data, status, xhr) {
                      console.log(data);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("error");
                    }
                  });

              })

            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              $('.lostpwd-form-main-message').addClass('error').html(XMLHttpRequest.status + ": 服务器异常,请稍后重试!");
            },
            complete: function(XMLHttpRequest, textStatus) {
              this; // 调用本次AJAX请求时传递的options参数
            }
          });
        };

        function nodata(res) {//数据加载完毕的操作
            if(res.length==0 || res.length < limit){
                $(".weui-loadmore").html('<div class="weui-loadmore_line"> <span class="weui-loadmore__tips">数据加载完毕</span> </div>');
                // $(document.body).destroyInfinite();
            }
            pageNum = pageNum + 1;
        };
          //品牌 规格 查询点击事件
        $(".modal-content").on('click','.brand',function(){
            var tag = 'brands';
            var _id = $(this).attr('data_id');
            // console.log(_id);
            location.href="/bf/wx/vendors/{{ club_id }}/category/items/"+_id+"/brands?category_id={{ category_id }}&second_category_id={{ second_category_id }}";
            $('#modal1').modal('close');

        }).on('click','.spec',function(){
          var tag = 'specs';
          var _id = $(this).attr('data_id');
          // console.log(_id);
          location.href="/bf/wx/vendors/{{ club_id }}/category/items/"+_id+"/specs?category_id={{ category_id }}&second_category_id={{ second_category_id }}";
          $('#modal2').modal('close');
        });

        // 购物车数量
          var goods_num = {{ cart_goods_num }};
          // console.log(num);
          if(goods_num>0){
              $("#shop-car span:first-child").addClass('mark');
              $("#shop-car span:first-child").html(goods_num);
          }else{
            $("#shop-car span:first-child").removeClass('mark');
          }

    })
    </script>
  </body>
</html>
