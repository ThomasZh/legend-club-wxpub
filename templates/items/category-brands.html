<!-- blank page @2017/05/23 -->
<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <title>商品列表－品牌</title>
    <meta name="description" content="Material Design Mobile Template">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Icons -->
    <link href="{{ static_url('shuttle/css/ionicons.min.css') }}" media="all" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="{{ static_url('weui/css/weui.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('weui/css/jquery-weui.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/animate.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/materialize.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swipebox.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swiper.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/main.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle-master/css/category.css') }}">
    <script src="{{ static_url('shuttle/js/vendor/modernizr-2.7.1.min.js') }}"></script>
    <style media="screen">
      #content ul{display:none;}
      #c-tab li.current{background-color: white;}
      .modal-content {
        height: auto;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content:space-between;
        align-items:center;
      }
      .modal-content .active{
        background-color: #01acc6;
        color: white;
      }
      .cart{
        position: fixed;
        bottom: 3rem;
        left: 1.5rem;
      }
      .mark{
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: block;
        border-radius: 50%;
        background-color: #ef4018;
        width: 1.5rem;
        height: 1.5rem;
        line-height: 1.5rem;
        font-size: 1.2rem;
        text-align: center;
        color:white;
        font-weight: 600;
      }

      .spec_list
      {
        padding-top: 5px;
        margin-bottom: 5px;
      }

      .spec_item
      {
        border-top:1px solid #e0e0e0;
        margin-top: 10px;
      }
      .position{
        width:15%;
        font-size: 12px;
        text-align: center;
        line-height: 40px;
        color: white;
      }
      .c-position{
        display: none;
        position: absolute;
        right: 0;
        top: 48px;
        width: 15%;
        font-size: 12px;
        background: #01acc6;
        text-align: center;
        line-height: 30px;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Main Container -->
    <div id="main" class="main">
      <!-- Toolbar -->
      <div id="toolbar" class="primary-color z-depth-1" style="height:48px;transform: translate3d(0, 0, 0);">
        <!-- Tabs -->
        <ul class="tabs" style="width:85%; overflow-x:scroll;margin:0;">
          {% for category in categorys %}
            {% if category['_id'] == _brand['super_category_id'] %}
            <li class="tab col s2"><a style="font-size: 18px; display:inline;" onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category['_id'] }}'" class="active">{{ category['title'] }}</a></li>
            {% else %}
            <li class="tab col s2"><a style="font-size: 18px; display:inline;" onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category['_id'] }}'">{{ category['title'] }}</a></li>
            {% end %}
          {% end %}
        </ul>
        <div class="position">
          <i class="ion-android-arrow-dropdown right" style="margin-right: 10px;margin-left:0;font-size:1.8rem;"></i>
          {% if club_id == "ef7ad69e75bc11e7a81600163e007856" %}
          <a href="#modal3" class="drop-condition" style="margin-left: 5px;" id="addr-name">北京</a>
          {% elif club_id == "81cf359e282e11e7812a00163e007856" %}
          <a href="#modal3" class="drop-condition" style="margin-left: 5px;" id="addr-name">临沂</a>
          {% end %}
        </div>
      </div>
      <!-- End of Toolbar -->

      <!-- Page Contents -->
      <div class="with-tab animated fadeinup with-filters">
        <!-- 规格条件 -->
        <div class="fixed" style="width:78%;">
          <div class="row filters">
            <div class="col s6 center ">
              <a href="#modal2" class="drop-condition ">
                规格<i class="ion-chevron-down"></i>
              </a>
            </div>
            <div class="col s6 center left-border">
              <a href="#modal1" class="drop-condition">
                品牌<i class="ion-chevron-down"></i>
              </a>
            </div>
          </div>
        </div>
        <!-- 商品分类 -->
        <div id="product1" class="row product">
          <div class="col s3 sub-category" style="position: fixed;z-index:99;height:100%; width:22%;">
            <ul class="collection" id="c-tab">
              {% for second_category in second_categorys %}
                {% if second_category['_id'] == _brand['category_id'] %}
                <li class="collection-item current" style="padding-left: 5px; padding-right: 5px;"><a style="font-size: 12px; font-weight: bold;" data_id="{{ second_category['_id'] }}" class="second-category-btn" onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category_id }}&second_category_id={{ second_category['_id'] }}'">{{ second_category['title'] }}</a></li>
                {% else %}
                <li class="collection-item" style="padding-left: 5px; padding-right: 5px;"><a style="font-size: 12px; font-weight: bold;" data_id="{{ second_category['_id'] }}" class="second-category-btn" onclick="location.href='/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category_id }}&second_category_id={{ second_category['_id'] }}'">{{ second_category['title'] }}</a></li>
                {% end %}
              {% end %}
            </ul>
          </div>
          <div class="col s12" style="margin-top: 4.6rem;padding-left:85px;">
            <ul class="collection" style="display:block;" id="content"></ul>
            <div class="weui-loadmore">
              <i class="weui-loading"></i>
              <span class="weui-loadmore__tips">正在加载</span>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Page Contents -->
    </div>
    <!-- End of Main Container -->
    <!-- 购物车图标 -->
    <div class="floating-button animated bouncein delay-3 cart" style="z-index:999;">
      <a id="shop-car" href="/bf/wx/vendors/{{ club_id }}/items/cart" class="btn-floating btn-large waves-effect waves-light btn z-depth-1">
        <span class=""></span><i class="ion-ios-cart"></i>
      </a>
    </div>
    <!-- Modal Structure -->
    <div id="modal1" class="modal bottom-sheet">
      <div class="modal-content">
        <!-- <h4>Modal Header</h4> -->
        <a href="/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category_id }}&second_category_id={{ second_category_id }}" class="checkbox spec" style="curser:pointer;margin-bottom: 1rem;"><span>全部</span></a>
        {% for second_brand in second_brands %}
          {% if second_brand['_id'] == brand_id %}
          <span class="checkbox brand active" data_id="{{ second_brand['_id'] }}" style="curser:pointer;margin-bottom: 1rem;">{{ second_brand['title'] }}</span>
          {% else %}
          <span class="checkbox brand" data_id="{{ second_brand['_id'] }}" style="curser:pointer;margin-bottom: 1rem;">{{ second_brand['title'] }}</span>
          {% end %}
        {% end %}
      </div>
    </div>

    <div id="modal2" class="modal bottom-sheet">
      <div class="modal-content">
        <!-- <h4>Modal Header</h4> -->
        <a href="/bf/wx/vendors/{{ club_id }}/category/items?category_id={{ category_id }}&second_category_id={{ second_category_id }}" class="checkbox spec active" style="curser:pointer;margin-bottom: 1rem;"><span>全部</span></a>
        {% for second_spec in second_specs %}
          <span class="checkbox spec" data_id="{{ second_spec['_id'] }}" style="curser:pointer;margin-bottom: 1rem;">{{ second_spec['title'] }}</span>
        {% end %}
      </div>
    </div>

    <!-- Modal Structure -->
    <div id="modal3" class="modal bottom-sheet">
      <div class="modal-content">
        <h4 style="width:100%;">选择地区</h4>
        {% if club_id == "ef7ad69e75bc11e7a81600163e007856" %}
        <span class="checkbox addr active" style="margin-bottom: 1rem;" data_id="ef7ad69e75bc11e7a81600163e007856">北京</span>
        <span class="checkbox addr" style="margin-bottom: 1rem;" data_id="81cf359e282e11e7812a00163e007856">临沂</span>
        {% else %}
        <span class="checkbox addr" style="margin-bottom: 1rem;" data_id="ef7ad69e75bc11e7a81600163e007856">北京</span>
        <span class="checkbox addr active" style="margin-bottom: 1rem;" data_id="81cf359e282e11e7812a00163e007856">临沂</span>
        {% end %}
      </div>
    </div>

    <!-- Scripts -->
    <script src="{{ static_url('shuttle/js/vendor/jquery-2.1.0.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/helper.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/HeadsUp.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.smoothState.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.mixitup.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.swipebox.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/masonry.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/swiper.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/materialize.js') }}"></script>
    <script src="{{ static_url('weui/js/jquery-weui.min.js') }}"></script>
    <script src="{{ static_url('shuttle-master/js/category.js') }}"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script>
      wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '{{ wx_app_id }}', // 必填，公众号的唯一标识
        timestamp: '{{ sign["timestamp"] }}', // 必填，生成签名的时间戳
        nonceStr: '{{ sign["nonceStr"] }}', // 必填，生成签名的随机串
        signature: '{{ sign["signature"] }}',// 必填，签名，见附录1
        jsApiList: ['onMenuShareTimeline','onMenuShareAppMessage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
      });

      wx.ready(function(){
        wx.onMenuShareAppMessage({
          title: '{{ club["name"] }}', // 分享标题
          desc: '{{ club["introduction"] }}', // 分享描述
          link: '{{ share_url }}', // 分享链接
          imgUrl: '{{ club["img"] }}!200x200', // 分享图标
          type: 'link', // 分享类型,music、video或link，不填默认为link
          dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
          success: function () {
            // 弹出提示窗口
            alert("分享此页面，好友下单购买，您可获得购买金额1%积分！");
            //$(".ui-dialog").dialog("show");
          },
          cancel: function () {
            // 用户取消分享后执行的回调函数
          }
        });

        wx.onMenuShareTimeline({
          title: '{{ club["name"] }}', // 分享标题
          link: '{{ share_url }}', // 分享链接
          imgUrl: '{{ club["img"] }}!200x200', // 分享图标
          success: function () {
            // 弹出提示窗口
            alert("分享此页面，好友下单购买，您可获得购买金额1%积分！");
            //$(".ui-dialog").dialog("show");
          },
          cancel: function () {
            // 用户取消分享后执行的回调函数
          }
        });
      });
    </script>
    <script type="text/javascript">
    $(function(){
        // 二级菜单切换
          var $li = $('#c-tab li');
          var $ul = $('#content ul');
        $li.on('click',function(){
            var $this = $(this);
            var $t = $this.index();
            $li.removeClass('current');
            $this.addClass('current');
            $ul.css('display','none');
            $ul.eq($t).css('display','block');
          });
      // 二级菜单内容查询
      var pageNum = 1;
      var limit = 5;
      // 上拉加载更多start
        var loading = false;  //状态标记
        $(document.body).infinite().on("infinite", function() {
          if(loading) return;
          loading = true;
          setTimeout(function() {
            getitems("brands","{{ brand_id }}");
            loading = false;
          }, 1000);   //模拟延迟
        });
      // end
        getitems("brands","{{ brand_id }}");//获取数据函数
        // 查询二级分类下的商品
        function getitems(dom,id){
          $.ajax({
            type: "GET",
            url: "{{ API_DOMAIN }}/api/def/"+dom+"/"+ id +"/items?attach_category=yes&page="+pageNum+"&limit="+limit,
            dataType: "json",
            headers: {"Authorization":"Bearer {{access_token}}"},
            contentType: 'application/json',
            success: function(data, status, xhr) {
              console.log(data);
              var dataObj = data.rs.data;

              var html = '';
              for (var i=0;i<dataObj.length;i++){
                html += '<li class="collection-item avatar" style="padding-left:95px;">';
                html += '<img src="'+ dataObj[i]['img'] +'!200x200" style="border-radius:0; margin-top: -5px; left: 4px; width: 85px; height: 85px;" class="circle prod_img">';
                html += '<span class="title" style="font-weight: bold;">'+dataObj[i]['title']+'</span>';
                html += '<p>品牌: '+dataObj[i]['brand_title']+'</p>';

                html += '<ul class="spec_list" style="display:block;">';

                var specs = dataObj[i].specs;
                for(var j = 0;j<specs.length;j++){
                  html += '<li class="spec_item" style="display:block;">';
                  html += '<p>规格: '+specs[j]['title']+'</p>';
                  html += '<div class="hilight">';
                  html += '<span>'+specs[j]['amount']/100+'元/'+specs[j]['unit']+'</span>';
                  html += '<div class="hilight-right hidden">'
                  html += '<a href="#!" class="left-side" spec_id = "'+ specs[j]['spec_id'] +'" data_id = "'+dataObj[i]['_id']+'"><i class="ion-minus-circled"></i></a>';
                  html += '<input type="number" min="1" style="width:3.5rem;height:2rem;line-height:2rem;margin-bottom:0;font-size:14px;" class="quantity" value="0"/>';
                  html += '<a href="#!" class="right-side" spec_id = "'+ specs[j]['spec_id'] +'" data_id = "'+dataObj[i]['_id']+'"><i class="ion-plus-circled"></i></a>';
                  html += '</div></div></li>';
                }
                html += '</ul>';
                html += '</li>';
              }
              $("#content").append(html);
              nodata(dataObj);

            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              $('.lostpwd-form-main-message').addClass('error').html(XMLHttpRequest.status + ": 服务器异常,请稍后重试!");
            },
            complete: function(XMLHttpRequest, textStatus) {
              this; // 调用本次AJAX请求时传递的options参数
            }
          });
        };

        $(document).on('click','.right-side',function(event){
            var step = 1;
            var num = $(this).prev().val();
                num ++;
            $(this).prev().val(num);
            goods_num = goods_num + step;
            if(num == 1){
              $("#shop-car span:first-child").addClass('mark');
              // $("#shop-car span:first-child").text(goods_num);
            }else{
              // $("#shop-car span:first-child").text(goods_num);
            }
            $(this).parent().removeClass('hidden');
            var item_id = $(this).attr('data_id');
            var tem_id = $(this).attr('spec_id');
            // var product_num = parseInt($(this).prev().text())-parseInt(begin_num);
            var data = {"spec_id":tem_id, "quantity":step};
            var json = JSON.stringify(data);
            console.log(json);
            $.ajax({
              type: "POST",
              url: "{{ API_DOMAIN }}/api/clubs/{{ club_id }}/cart/items/"+ item_id +"/increase",
              data: json,
              dataType: "json",
              headers: {"Authorization":"Bearer {{access_token}}"},
              contentType: 'application/json',
              success: function(data, status, xhr) {
                // console.log(data);
                if(data.data.quantity > 99){
                  data.data.quantity = "99+";
                }
                $("#shop-car span:first-child").html(data.data.quantity);
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                  // console.log("error");
              }
            });
        }).on('click','.left-side',function(){
          var step = 1;
          var num = $(this).next().val();
              if(num <= 0){
                num = 0;
              }
              num -- ;
              goods_num = goods_num - step;
              // $("#shop-car span:first-child").text(goods_num);
          if(num == 0){
            $(this).parent().addClass('hidden');
            if(goods_num == 0){
              $("#shop-car span:first-child").removeClass('mark');
              $("#shop-car span:first-child").html('');
            }
          }
            $(this).next().val(num);
            var tem_id = $(this).attr('spec_id');
            var item_id = $(this).attr('data_id');
            var data = {"spec_id":tem_id,"quantity":step};
            var json = JSON.stringify(data);
            // console.log(json);
            $.ajax({
              type: "POST",
              url: "{{ API_DOMAIN }}/api/clubs/{{ club_id }}/cart/items/"+ item_id +"/decrease",
              data: json,
              dataType: "json",
              headers: {"Authorization":"Bearer {{access_token}}"},
              contentType: 'application/json',
              success: function(data, status, xhr) {
                // console.log(data);
                if(data.data.quantity > 99){
                  data.data.quantity = "99+";
                }else if(data.data.quantity == 0){
                  $("#shop-car span:first-child").html('');
                }else{
                  $("#shop-car span:first-child").html(data.data.quantity);
                }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                  // console.log("error");
              }
            });

        });

        // 给数目输入框绑定事件
        $(document).on('change','.quantity',function(){
          var val = parseInt($(this).val());
          console.log(val);
          if (isNaN(val) || val <= 0) {
              val = 1;
              $(this).val(val)
          }
          goods_num = goods_num + val;
          var tem_id = $(this).next().attr('spec_id');
          var item_id = $(this).next().attr('data_id');
          var data = {"spec_id":tem_id,"quantity":val};
          var json = JSON.stringify(data);
          console.log(json);
          $.ajax({
            type: "POST",
            url: "{{ API_DOMAIN }}/api/clubs/{{ club_id }}/cart/items/"+ item_id +"/update",
            data: json,
            dataType: "json",
            headers: {"Authorization":"Bearer {{access_token}}"},
            contentType: 'application/json',
            success: function(data, status, xhr) {
              // console.log(data.data.quantity);
              if(data.data.quantity > 99){
                data.data.quantity = "99+";
              }
              $("#shop-car span:first-child").html(data.data.quantity);
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("error");
            }
          });
        });

        function nodata(res) {//数据加载完毕的操作
            if(res.length==0 || res.length < limit){
                $(".weui-loadmore").html('<div class="weui-loadmore_line"> <span class="weui-loadmore__tips">数据加载完毕</span> </div>');
                $(document.body).destroyInfinite();
            }
            pageNum = pageNum + 1;
        };

        //选择地区点击事件
        $(".modal-content").on('click','.addr',function(){
            var club_id = $(this).attr('data_id');
            location.href="/bf/wx/vendors/"+ club_id +"/category/items";
        });

          //品牌 规格 查询点击事件
        $(".modal-content").on('click','.brand',function(){
            var tag = 'brands';
            var _id = $(this).attr('data_id');
            // console.log(_id);
            location.href="/bf/wx/vendors/{{ club_id }}/category/items/"+_id+"/brands?category_id={{ category_id }}&second_category_id={{ second_category_id }}";
            $('#modal1').modal('close');

        }).on('click','.spec',function(){
          var tag = 'specs';
          var _id = $(this).attr('data_id');
          // console.log(_id);
          location.href="/bf/wx/vendors/{{ club_id }}/category/items/"+_id+"/specs?category_id={{ category_id }}&second_category_id={{ second_category_id }}";
          $('#modal2').modal('close');
        });

        // 购物车数量
          var goods_num = {{ cart_goods_num }};
          // console.log(num);
          if(goods_num>0){
              $("#shop-car span:first-child").addClass('mark');
              $("#shop-car span:first-child").html(goods_num);
          }else{
            $("#shop-car span:first-child").removeClass('mark');
          }

    })
    </script>
  </body>
</html>
